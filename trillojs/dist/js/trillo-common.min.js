/*!
 * TrilloJS v0.5.0 (https://github.com/trillo/trillojs#readme)
 * Copyright 2017 Collager Inc.
 * Licensed under the MIT license
 */
!function(){"use strict";Trillo.EntityAdapter=Trillo.inherits(Trillo.ApiAdapter,function(a,b){Trillo.ApiAdapter.call(this,a,b)});var a=Trillo.EntityAdapter.prototype;a.isApiSpecChanged=function(a){var b=this.model().data;return!b||b.uid!==this.model().getContextUid()},a.getObserverOptions=function(a){return a&&a.uid?{cls:Trillo.uidToClass(a.uid)}:null},a.loadData=function(){var a,b=$.Deferred(),c=this.model().getContextUid();if(!c)return Trillo.log.warning("Entity model does not specify object uid which is required to retrieve uid, returning empty data"),b.resolve({}),b.promise();if(this.apiSpec.options&&this.apiSpec.options.detailClass){a=$.Deferred(),$.ajax({url:"/_service/entity?uid="+c,type:"get"}).done(function(b){a.resolve(b)}).fail(function(){a.reject({errorMsg:"Failed to load entity"})});var d=$.Deferred();$.ajax({url:"/_service/entityDetail?uid="+this.apiSpec.options.detailClass+"."+Trillo.uidToId(c),type:"get"}).done(function(a){d.resolve(a)}).fail(function(){d.reject({errorMsg:"Failed to entity details"})}),$.when(a.promise(),d.promise()).done($.proxy(this.dataLoaded,this,b)).fail(function(){b.reject({errorMsg:"Failed to load model"})})}else a=$.Deferred(),$.ajax({url:"/_service/entity?uid="+c,type:"get"}).done(function(b){a.resolve(b)}),a.promise().done($.proxy(this.dataLoaded,this,b)).fail(function(){b.reject({errorMsg:"Failed to load model"})});return b.promise()},a.dataLoaded=function(a,b,c){b=$.extend(b,c),a.resolve(b)}}(),function(){"use strict";Trillo.PaginationAdapter=Trillo.inherits(Trillo.ApiAdapter,function(a,b){Trillo.ApiAdapter.call(this,a,b),this.lastPageNumberParam=-1,this.lastPageRequestStr=null});var a=Trillo.PaginationAdapter.prototype;a.isApiSpecChanged=function(a){var b=Trillo.stringify(this.getPageRquest(this.lastPageNumberParam));return this.lastPageRequestStr!==b},a.getPageRquest=function(a){var b=this.apiSpec,c={};return c.pageNumber="undefined"==typeof a?1:a,c.cls=b.cls,b.filter?c.filter=Mustache.render(b.filter,this.model().getDataReferences()):c.filter="",c.searchFilter=b.searchFilter,c.searchPhrase=b.searchPhrase||"",c.orderBy=b.orderBy||"",c.pageSize=b.pageSize||32,c.assocName=b.assocName,c.filter||(c.assocUid=this.model().getContextUid()),c},a.getObserverOptions=function(a){return{cls:this.apiSpec.cls}},a.loadData=function(a,b){var c=$.Deferred(),d=this.getPageRquest(a);return this.lastPageNumberParam=a,this.lastPageRequestStr=Trillo.stringify(d),$.ajax({url:"/_service/page",type:"post",data:this.lastPageRequestStr,contentType:"application/json",datatype:"application/json"}).done($.proxy(this.dataLoaded,this,c,b)).fail(function(){c.reject({errorMsg:"Failed to load model"})}),c.promise()},a.dataLoaded=function(a,b,c){a.resolve(c,!!c.items,b)},a.setOrderBy=function(a){this.apiSpec.orderBy=a}}(),function(){"use strict";Trillo.TreeAdapter=Trillo.inherits(Trillo.ApiAdapter,function(a,b){Trillo.ApiAdapter.call(this,a,b)});var a=Trillo.TreeAdapter.prototype;a.loadData=function(){var a=$.Deferred();return $.ajax({url:"/_service/tree?name="+this.controller().view().name,type:"get"}).done($.proxy(this.treeLoaded,this,a)),a.promise()},a.getObserverOptions=function(a){return a&&a.uid?{uid:a.uid}:{cls:"Tree"}},a.treeLoaded=function(a,b){a.resolve(b)},a.treeLoaded2=function(a){this._controller.dataAvailable(a),this.triggerModelDataChanged()},a.receivedNotifications=function(a){(this.model().data.uid===a.uid||this.model().data.name===a.name)&&(this.model().clearObserver(),$.ajax({url:"/_service/tree?name="+this.controller().view().name,type:"get"}).done($.proxy(this.treeLoaded2,this)))}}(),function(){"use strict";Trillo.SearchHandler=function(a){this.searchBoxSelector=".js-search",this.searchTextSelector=".js-search-textbox",this.searchActionSelector=".js-search-action";var b=$(this.searchBoxSelector);if(0!==b.length){this.setContext(a),this.cls="VMPhraseSuggester",Trillo.isTouchSurface&&$(this.searchTextSelector).attr("touchsurface","yes");var c=$(this.searchTextSelector).typeahead([{name:"query1",remote:{url:"/_search/suggest?cls="+this.cls+"&q=%QUERY",maxParallelRequests:1,cache:!1},valueKey:"v",limit:5}]).on("typeahead:enterPressed typeahead:selected",$.proxy(this.searchPhraseAvailable,this));this.$typeahead=c,$(this.searchActionSelector).on("click",$.proxy(this.searchActionClicked,this))}};var a=Trillo.SearchHandler.prototype;a.setDataSetEnabled=function(a,b){this.$typeahead.typeahead("setDataSetEnabled",a,b)},a.searchActionClicked=function(a){a&&(a.stopPropagation(),a.preventDefault()),this.searchPhraseAvailable()},a.searchPhraseAvailable=function(a,b,c,d){this.context&&(b=$.trim($(this.searchTextSelector).val()),this.context.searchPhraseAvailable(a,b,c,d))},a.setContext=function(a,b){this.context&&(this.context.searchHandler=null),this.cls=b,this.context=a;var c=$(this.searchBoxSelector);this.context?this.context.searchHandler=this:c.hide()}}();